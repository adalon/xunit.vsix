<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <!-- Ignore warning about xunit.vsix.bootstrap being x86 -->
    <ResolveAssemblyWarnOrErrorOnTargetArchitectureMismatch>None</ResolveAssemblyWarnOrErrorOnTargetArchitectureMismatch>
		<CompileDependsOn>
      GetVsixFrameworkInfoFile;
      GenerateVsixFrameworkInfo;
      IncludeVsixFrameworkInfo;
      $(CompileDependsOn);
    </CompileDependsOn>
	</PropertyGroup>

  <Target Name="GetVsixFrameworkInfoFile">
    <ItemGroup>
      <VisualStudioVersion Include="$(VisualStudioVersions)" />
    </ItemGroup>
    <PropertyGroup>
      <!-- The item list concatenation wouldn't work outside a target -->
      <VsixFrameworkInfoFile Condition="'$(VsixFrameworkInfoFile)' == ''">$(IntermediateOutputPath)AssemblyInfo.VsixFramework-@(VisualStudioVersion, '-')-$(RootSuffix).g$(DefaultLanguageSourceExtension)</VsixFrameworkInfoFile>
    </PropertyGroup>
  </Target>

  <Target Name="GenerateVsixFrameworkInfo"
			Inputs="$(MSBuildProjectFullPath)"
			Outputs="$(VsixFrameworkInfoFile)">

    <ItemGroup>
      <_VisualStudioVersion Include="$(VisualStudioVersions)" />
      <_QuotedVisualStudioVersion Include="@(_VisualStudioVersion -> '&quot;%(Identity)&quot;')" />
    </ItemGroup>
    <PropertyGroup>
      <_QuotedVisualStudioVersion>@(_QuotedVisualStudioVersion, ', ')</_QuotedVisualStudioVersion>
    </PropertyGroup>
    
		<WriteLinesToFile File="$(VsixFrameworkInfoFile)" Lines="[assembly: Xunit.TestFrameworkAttribute (&quot;Xunit.VsixTestFramework&quot;, &quot;xunit.vsix&quot;)]" Overwrite="true" />
    <WriteLinesToFile Condition=" '$(GenerateAssemblyVsixAttribute)' == 'true' " File="$(VsixFrameworkInfoFile)" Lines="// Customize by providing $(VisualStudioVersions) and $(RootSuffix) MSBuild properties" Overwrite="false" />
    <WriteLinesToFile Condition=" '$(GenerateAssemblyVsixAttribute)' == 'true' " File="$(VsixFrameworkInfoFile)" Lines="// Turn off attribute generation by setting $(GenerateAssemblyVsixAttribute) to 'false'" Overwrite="false" />
    <WriteLinesToFile Condition=" '$(GenerateAssemblyVsixAttribute)' == 'true' " File="$(VsixFrameworkInfoFile)" Lines="[assembly: Xunit.Vsix ($(_QuotedVisualStudioVersion), RootSuffix = &quot;$(RootSuffix)&quot;)]" Overwrite="false" />
    <ItemGroup>
			<FileWrites Include="$(VsixFrameworkInfoFile)" />
		</ItemGroup>
	</Target>

	<Target Name="IncludeVsixFrameworkInfo">
		<ItemGroup>
			<Compile Include="$(VsixFrameworkInfoFile)" />
		</ItemGroup>
	</Target>

</Project>